# S4 Shell Tools

> **WARNING**: This code is not very old, and isn't really in a releasable state right now. I put it here for collaboration purposes. It will function as advertised and has been 'tried out' in the sense that it's built a mod or two that I've tested in-game. However, it lacks unit tests, and the documentation currently leaves much to be desired.<br/> 
> **BE ADVISED:** while I've been coding in server side languages like Java for a quite a while, I only picked up Typescript a couple of years ago. If you have suggestions about how I might make this more idiomatic and standardized for the Typescript ecosystem, create an issue in this project with a suggestion, or a pull request.  

## Overview

This repository contains the Typescript code and build files to generate a command line tool to build and manipulate Sims 4 `.package` files. The command line tool is just a file organizer that relies on the [Sims 4 Tool Kit](https://sims4toolkit.com/#/) library to do the heavy lifting of managing the binary data in the `.package` files.

See [Why is this](#Why-is-this) below for the rationale behind this code.

## Installation
I haven't set up publishing this to npmjs yet, so you will need to check out the repository, then run these commands to build the scripts:
```shell
npm run build
```
This will build the javascript files to the `out/` folder.

To run the script, you can:
* Install it globally by running `npm install -g` from inside the repository folder, then call it with: 
  ```shell
  S4ShellTools <command and options>
  ```
* Run the script from the repo: 
  ```shell
  $REPO_PATH/out/S4ShellTools.js <command and options>
  ```
* Run the typescript directly with npx or ts-node: 
  ```shell
  ts-node $REPO_PATH/src/S4ShellTools.ts <command and options>
  ```

## Usage
```
Usage: S4ShellTools --help

Tools to build and manage a Sims 4 .package file

Options:
  -V, --version                                          output the version number
  -h, --help                                             display help for command

Commands:
  build <buildConfigPath>
  merge <outputPath> [packagePaths...]
  dump-strings <packageFile> <outputDirectory>
  import-property-files <outputPath> [propertyFiles...]
  string-summary <sourcePath>
  find-duplicate-tuning <sourcePath>
  help [command]                                         display help for command

```

### build _</path/to/build.yml>_
Builds a Sims 4 package based on a `build.yml` build specification file. 

The `build` command is pretty much the point of this entire tool. The rest of the commands are meant to support it over the course of a mod's lifecycle. A `build.yml` file can specify the tuning xml files that should be included, string `.properties` formatted text files that should be imported into `STBL` resources, and other `.package` files that should be merged into the final output `.package` or packages.

**Limitations** 
The tools used cannot currently import certain animation-related `.xml` files, such as `*.AnimationStateMachine.xml` and `*.Walkstyle.xml` files, as those require special encoding that isn't handled by the underlying library (yet?). For those types of files, as well as all other types of binary resources, such as ObjectDefinitions and models, images, and animations, you will need to use [S4Studio](https://sims4studio.com/) to work with them. [S4Studio](https://sims4studio.com/) takes the XML files for ASM's and walkstyles, and generates a (pretty complicated) binary format from them. The same is true of `*.SimData.xml` files, but [S4TK](https://sims4toolkit.com/#/) handles `*.SimData.xml` files, so those can safely be imported by these notes. 

**Exception** This tool and the underlying [S4TK](https://sims4toolkit.com/#/) library **can merge** packages that contain things like ObjectDefinitions and models, etc.  My workflow is to use [S4Studio](https://sims4studio.com/) as an object resource editor on packages that don't have any XML tuning in them, then I merge those with the tuning and strings packages built with `S4ShellTools`. 

Example of a `build.yml` file:
```
output: build
exclude:
  - _attic
packages:
  - name: mod_tuning.package
    files:
      - src/**/*
strings:
  - files:
      - strings/220557DA!80000000!00000000994531AC.properties
merges:
  - name: MyKewlMod.package
    files:
      - build/strings_package.package
      - build/test_tuning.package
      - include/objects_and_animations.package
```
All paths in the file are relative to the directory of the `build.yml` file, unless absolute paths are used. The sections are as follows:

#### output:
Specifies the output directory for the various build artifacts, such as .package files, generated by the script. The directory will be created if it doesn't exist.

#### exclude:
Specifies a list of strings that can be used to exclude files and directories from the build process. It's not a regular expression, but a simple substring match, but you can list more than one to exclude.

#### packages:
Specifies a list of package names to build along with the tuning files to build them from. This enables you to build multiple `.package` files from multiple different lists of tuning files. The format of each item in the `packages` list is as follows:
```
packages:
    - name: NameOfOutputPackage.package
      files:
        - e882d22f!00000000!A19BE1FCCFBC6EEA.s4shelltools_astonished_reaction.Interaction.xml
        - 6017E896!00000022!E36EB044E4DF6978.s4shelltools_astonished_buff.BuffTuning.xml
        - 545AC67A!0017E8F6!E36EB044E4DF6978.s4shelltools_astonished_buff.SimData.xml
    - name: NameOfAnotherOutputPackage.package
      files:
        - src/**/*
```

##### name:
The name of the package file to build, relative to the build output folder.

##### files:
List of file globs with [S4Studio](https://sims4studio.com/) formatted names. This means the files should be formatted as follows:

```
TuningType!GroupId!InstanceId.name_of_object_inside_xml.tuningType.xml
```  
e.g.,  
```
e882d22f!00000000!A19BE1FCCFBC6EEA.s4shelltools_astonished_reaction.Interaction.xml
```

This is how both [S4Studio](https://sims4studio.com/) and the XML Extractor (if you set it to be compatible with [S4Studio](https://sims4studio.com/)) export XML tuning files, so there are many examples to look at. 

As you can see in the second package in the example above, file glob expressions are also available in the `files:` lists. In fact, all entries are treated like file glob expressions, even if they only end up pointing to a single file.

You can configure as many different packages and sets of tuning files to build as you'd like. Each specification is entirely independent, so if you wanted to build different versions of the same packages with different tuning files included, that can be handled.

#### strings:
List of string package specifications in a similar format to `packages:` section. At the moment, however, you can only build a single strings package, and it is always named strings_tuning.package in the build output folder. 

#### files:
List of file globs pointing to `.properties` files with [S4Studio](https://sims4studio.com/) formatted names. This means the files should be formatted as follows:

`TuningType!GroupId!InstanceId.properties`

**Example:** `220557DA!80000000!0000000099C531AC.properties`

The file name format for string files may be a bit in flux. Right now, you have to name the files properly yourself, including setting the first two digits of the `InstanceId` to the [language locale code](https://sims4toolkit.com/#/docs/models/0.3.0/enums/StringTableLocale). I'm investigating the possibility of generating opaque randomized STBL identifiers, and property files with names and standard language abbreviations (such as `en`, `fr`, `de`), since they don't need to be significant, just unique. It would let you use the rest of the name for something meaningful (like what's in the file).

The property file format is a plain text file that looks like this
`StringHashCode=ContentsOfString`. Note that although the properties file specification allows variation in what is used as the delimiter, you always need to use the equals sign in this case.

**Example**
```
0xCC3DE3E0=Locate Target
0xD889ABA1=Locate the Target of your current mission
```
#### merges:
The `merges:` section of the `build.yml` file specifies packages that should be merged into a final build product. The packages built by the rest of the file are not automatically included in the `merge:` section, since you have the option of picking and choosing which 'source packages' you want to merge into the final packages.

This is also where you should include `.package` files that contain binary resources not handled by this tool, such as Object Definitions, animations, walkstyles and images. This will allow you to continue to edit those items in [S4Studio](https://sims4studio.com/), and then merge those packages with the ones containing tuning files and strings created by the `packages:` and `strings:` steps.

## merge _</path/to/output.package>_ _</path/to/a_package_to_include.package>_...
The `merge` command takes the path of the package to create followed by a list of packages to include inside it. There is no 'unmerge'. Building from source XML is intended to be a one way process, though you could still edit the built package with S4Studio, if you wish. You just can't unmerge it.

**Example**  
`S4ShellTools merge build/output.package output/package_1.package output/package_2.package`

This will generate a file at `build/output.package` that contains the contents of `output/package_1.package` and `output/package_2.package`.

## dump-strings _</path/to/packageFile.package>_ _</path/to/outputDirectory/>_
Extracts all the STBL resources from a package file as `.properties` files.

## import-property-files </path/to/outputfile.package> _</paths/to/s4studio_format_named_propertiesfiles.properties>..._
Creates a new package file from a list of `.properties` files.

## string-summary </path/to/sourcePackage.package>
Prints a table of the STBL resources in a package, along with the number of strings in each one. Handy for locating missing strings in translations or after upgrades and additions.

## find-duplicate-tuning </path/to/packages/folder/root>
Recursively searches through a folder of packages and reports any duplicate tuning files found. 

# Why is this
I build production software at my day job every day by typing code into a text file, clicking a few buttons or running a few simple commands, and I get a working thing out the other end (hopefully), such as a Java jar or a Golang executable. I don't need to worry about putting the right files in the right packages every time I build the thing. I just click the button, and my software thing comes out the other end of the workflow. The classic problem of 'It works for me (but not for you)' was mostly solved in professional software engineering a long time ago.

I want to work that same way when developing Sims 4 mods, since it would be more fun than hunting through lots of different package files trying to figure out what I did to break something, looking for missing or replicated tuning XML files, and all the other dumb mistakes I've made while developing mods late into the night on weekends. So these tools are meant to provide a solid replicable mod-building workflow, just like in real life with real software. Using these tools, two modders should be able to check out the same mod source code, build them automatically, and end up with identical .package files. 

I want to write all of my code in something like PyCharm, since I'm used to managing lots and lots of complicated source code files in various IDEs. I want to eliminate the toil involved in incorporating translated strings from users, as well as making it easier and much more approachable for users to help with translations. I want to be able to make use of the software engineering experience I've learned over my career, and put it to work to make building Sims 4 mods more enjoyable and less painful. A better world is possible. :)

## Who might want to use this?
People who make tuning-heavy Sims 4 mods, to begin with. If you are making Sims 4 custom content mods like hair or clothing that doesn't contain tuning files or other specialized behavior, you would probably have no use for this tool. [S4Studio](https://sims4studio.com/) does everything you need.

If you make mods that include tuning XML, especially lots of tuning, and/or have different versions of your mod for different download configurations, etc, this mod might help solve a lot of problems for you. Once you reach the point of complexity that you need to start getting really systematic on how you build the mod's package files, that's when you probably need this tool or something like it.

## Why would you do want to do this? It seems complicated.
Modding is complicated. Searching through a bunch of package files for replicated or missing tuning xml is complicated _(and can bring on a feeling of despair...)_, as is dealing with string files and translations. The complexity of this tool is meant to make a lot of other things a lot more straightforward and most importantly, replicable. Exactly the same every time you build the mod.

It lets you apply many more software engineering principles to the process of building a mod more easily.
* Simple description of exactly what gets put into a mod, so that it builds from source files exactly the same way every single time.
* Build output artifacts that you can treat as immutable. The `.packages` that you build probably never need to be reopened and edited. They can be easily built from scratch from a `build.yml` plan every time, exactly the same.
* The `.properties` files are the source code for the `STBL` language resources. Working with string resources as standard `.properties` files brings the benefits of all the existing software industry tooling for the format. It's also easy for someone to translate the file with nothing but a text editor, which immediately creates a much larger pool of potential translators. This file can be reincorporated into the build after translation. Searching, concatenation, batch changes -- there are a lot of ways to easily process text data.

# Future directions
The main goal of this tool, and its intended consumer, is a PyCharm IDE plugin that I'm developing to provide the capability to build .package files and compile python scripts in the same user interface, all at once by clicking a button. As such, the API (command line commands) is less likely to change than the code that implements it, since I'm calling the command line commands from another component (that is yet to be released). 

If you really want to use these tools in your own mod building pipelines at this point, you might want to fork the repository and work from that until the codebase is a bit more stable.
