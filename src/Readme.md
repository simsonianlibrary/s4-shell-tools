# Building a Mod with S4ShellTools

> **WARNING**: THIS IS STILL EXPERIMENTAL AND SUBJECT TO CHANGE! 
> THOROUGHLY TEST ANYTHING YOU BUILD WITH IT!

## S4ShellTools build _</path/to/build.yml>_
Builds a Sims 4 package based on a `build.yml` build specification file. 

The `build` command is pretty much the point of this entire tool. The rest of the commands are meant to support it over the course of a mod's lifecycle. A `build.yml` file can specify the tuning xml files that should be included, string `.properties` formatted text files that should be imported into `STBL` resources, and other `.package` files that should be merged into the final output `.package` or packages.

**Limitations** 
The tools used cannot currently import certain animation-related `.xml` files, such as `*.AnimationStateMachine.xml` and `*.Walkstyle.xml` files, as those require special encoding that isn't handled by the underlying library (yet?). For those types of files, as well as all other types of binary resources, such as ObjectDefinitions and models, images, and animations, you will need to use [S4Studio](https://sims4studio.com/) to work with them. [S4Studio](https://sims4studio.com/) takes the XML files for ASM's and walkstyles, and generates a (pretty complicated) binary format from them. The same is true of `*.SimData.xml` files, but [S4TK](https://sims4toolkit.com/#/) handles `*.SimData.xml` files, so those can safely be imported by these notes. 

**Exception** This tool and the underlying [S4TK](https://sims4toolkit.com/#/) library **can merge** packages that contain things like ObjectDefinitions and models, etc.  My workflow is to use [S4Studio](https://sims4studio.com/) as an object resource editor on packages that don't have any XML tuning in them, then I merge those with the tuning and strings packages built with `S4ShellTools` using this same tool. 

## Format of a build.yml file
Example of a `build.yml` file:
```
output: build
exclude:
  - _attic
packages:
  - name: mod_tuning.package
    files:
      - src/**/*
strings:
  - files:
      - strings/220557DA!80000000!00000000994531AC.properties
merges:
  - name: MyKewlMod.package
    files:
      - build/strings_package.package
      - build/mod_tuning.package
      - include/objects_and_animations.package
```
All paths in the file are relative to the directory of the `build.yml` file, unless absolute paths are used. The sections are as follows:

### output:
Specifies the output directory for the various build artifacts, such as .package files, generated by the script. The directory will be created if it doesn't exist. Defaults to `./build`;

### exclude:
Specifies a list of strings that can be used to exclude files and directories from the build process. It's not a regular expression, but a simple substring match, but you can list more than one to exclude.

### packages:
Specifies a list of package names to build along with the tuning files to build them from. This enables you to build multiple `.package` files from multiple different lists of tuning files. The format of each item in the `packages` list is as follows:
```
packages:
    - name: NameOfOutputPackage.package
      files:
        - oldsrc/e882d22f!00000000!A19BE1FCCFBC6EEA.s4shelltools_astonished_reaction.Interaction.xml
        - oldsrc/6017E896!00000022!E36EB044E4DF6978.s4shelltools_astonished_buff.BuffTuning.xml
        - oldsrc/545AC67A!0017E8F6!E36EB044E4DF6978.s4shelltools_astonished_buff.SimData.xml
    - name: NameOfAnotherOutputPackage.package
      files:
        - src/**/*
```

#### name:
The name of the package file to build, relative to the build output folder.

#### files:
List of file globs with [S4Studio](https://sims4studio.com/) formatted names. This means the files should be formatted as follows:

```
TuningType!GroupId!InstanceId.name_of_object_inside_xml.tuningType.xml
```  
e.g.,  
```
e882d22f!00000000!A19BE1FCCFBC6EEA.s4shelltools_astonished_reaction.Interaction.xml
```

This is how both [S4Studio](https://sims4studio.com/) and the XML Extractor (if you set it to be compatible with [S4Studio](https://sims4studio.com/)) export XML tuning files, so there are many examples to look at. You have to get all the numbers right for it to work. :)

As you can see in the second package in the example above, file glob expressions are also available in the `files:` lists. In fact, all entries are treated like file glob expressions, even if they only end up pointing to a single file.

You can configure as many different packages and sets of tuning files to build as you'd like. Each specification is entirely independent, so if you wanted to build different versions of the same packages with different tuning files included, that can be handled.

### strings:
List of string package specifications in a similar format to `packages:` section. 

#### name:
The name of the package file to build, relative to the build output folder.

#### files:
List of file globs pointing to `.properties` files with [S4Studio](https://sims4studio.com/) formatted names. This means the filenames should be formatted as follows:

`TuningType!GroupId!InstanceId.properties`

**Example:** `220557DA!80000000!0000000099C531AC.properties`

The file name format for string files may be a bit in flux. Right now, you have to name the files properly yourself, including setting the first two digits of the `InstanceId` to the [language locale code](https://sims4toolkit.com/#/docs/models/0.3.0/enums/StringTableLocale). I'm investigating the possibility of generating opaque randomized STBL identifiers, and property files with names and standard language abbreviations (such as `en`, `fr`, `de`), since they don't need to be significant, just unique. It would let you use the rest of the name for something meaningful (like what's in the file).

>**NOTE** STBL resources are currently reprocessed during `merge` operations. See below under [`merges:`](#merges:).

The property file format is a plain text file that looks like this
`StringHashCode=ContentsOfString`. Note that although the properties file specification allows variation in what is used as the delimiter, you always need to use the equals sign in this case.

**Example**
```
0xCC3DE3E0=Locate Target
0xD889ABA1=Locate the Target of your current mission
```
### merges:
The `merges:` section of the `build.yml` file specifies packages that should be merged into a final build product. The packages built by the rest of the file are not automatically included in the `merge:` section, since you have the option of picking and choosing which 'source packages' you want to merge into each final package. Duplicated resources found in more than one source package in each merge target section will fail build and report the duplicated resources found, rather than randomly pick one or the other.

This is also where you should include `.package` files that contain binary resources not handled by this tool, such as Object Definitions, animations, walkstyles and images. This will allow you to continue to edit those items in [S4Studio](https://sims4studio.com/), and then merge those packages with the ones containing tuning files and strings created by the `packages:` and `strings:` steps.

The current strategy for STBL resources is to extract all STBL resources from all packages when merging, then combine all the string entries together grouped by language code with entries with duplicated hash keys reduced to a single one, and build a brand new STBL with the same randomized instance ID 'base' for each language code, with the locale code set appropriately for the language. Strings missing from non-English language files are automatically copied from the English strings file. 

The randomized instance ID of the new STBLs generated is obtained like this (currently):
```
    let newStringTableId = fnv64(uuidv4(),true);
```
The keyspace of a UUIDv4 is extremely large, so inadvertent duplicates are unlikely. This will mean that the STBL IDs change each time you build the mod, but if you are primarily managing strings with .properties files, this shouldn't be a problem. I have not found any drawbacks with this strategy yet, but am on the lookout for any issues. 

I'm working on adding some properties to the build process to allow using a more stable final STBL ID base value. I don't see a good reason not to combine all the STBLs for a language into a single one during the build, however, but am open to input if there is one.
